---
title: "Predictive ability in meat quality traits"
author: "Belcy Karine Angarita Barajas"
date: "21/09/2020"
output: html_document
---


### 1. Predictive ability meat quality and carcass traits 

The statistical model fitted for each meat quality and carcass trait was: 

$\mathbf{Y= X \beta + Zu +e}$

Using 3 different relationship matrices, the genomic relationship matrix $\mathbf{G_{ibs}}$ computed as $VanRaden\ (2008)$,the genomic relationship matrix $\mathbf{G_{ibd}}$ computed as $Han\ and\ Abney\ (2011)$ and the additive relationship matrix $\mathbf{A_{22}}$.

To calculate the $predictive\ ability$, we used the Pearson correlation coefficient among predicted and observed phenotype $\hat{r}(y,\hat{y})$ obtained by 5-fold cross-validation.  

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dplyr)
library(kableExtra)

rm(list=ls())
#setwd("~/Documents/Github_heritability_predictability_Meat_Traits//")
setwd("~/Documents/Tesis_Maestria/Github_heritability_predictability_Meat_Traits//")
# Result by fold
fibs<-read.table("rfold_G")
fibd<-read.table("rfold_Gibd")
fAmat<-read.table("rfold_A22")



# 1. Correlation by replicate for each lesion count trait 
colnames(fibs)<-c("replicate","lc.trait","fold","cor_Gibs")
colnames(fAmat)<-c("replicate","lc.trait","fold","cor_A22")
colnames(fibd)<-c("replicate","lc.trait","fold","cor_Gibd")

# 2. Datafile correlation estimated in each iteration for each matrix
foldr<-fAmat%>%left_join(fibs)%>%left_join(fibd)
foldr<-foldr%>%filter(!is.na(cor_Gibs),!is.na(cor_Gibd))

rp<-foldr%>%arrange(replicate)%>%count(replicate)%>%filter(n==100)
foldr<-rp%>%left_join(foldr)
foldr<-foldr%>%select(replicate,lc.trait:cor_Gibd)
foldr%>%group_by(replicate,lc.trait)%>%count(replicate)%>%filter(n<5)

# 3. Mean of correlation y,yhat replicate
mfol<-foldr%>%group_by(lc.trait, fold)%>%summarise_if(is.numeric,mean)%>%
  summarise_if(is.numeric,mean)%>%select(lc.trait,cor_A22:cor_Gibd)
mfol<-mfol%>%mutate_if(is.numeric,round, 4)
```

```{r}
kable(mfol)%>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),full_width = F, 
               position = "center") %>%
  add_header_above(c(" ","Mean of predictive ability by each trait" = 3), italic = T,bold = T)
```
```{r}
# 4. Get the differences between models
foldr<-foldr%>%mutate(dA22_Gibs=(cor_A22-cor_Gibs), 
                      dA22_Gibd=(cor_A22-cor_Gibd),
                      dGibd_Gibs=(cor_Gibd-cor_Gibs)) 

```
## Set of functions from Schrauf (2021) paper to get the confidence intervals using abc bootstrap method

Code to do Hypotesis testing as in Ma tías F. Schrauf, Gustavo de Los Campos y Sebastián Munilla. $“Comparing\  genomic\ prediction\ models\ by\ means\ of\ cross validation.” $ Genomic Selection: Lessons Learned and Perspectives. Special topic in Frontiers in Plant Science /(2021): 2648.

```{r}
#======================================================================
# bootstrap function to estimate confidence intervals 
#======================================================================
boot_fun<-function(x,conf=0.99){
  ci<-boot::abc.ci(x,function(x,w) sum(x*w), conf = conf)
  ci[1]<-mean(x)
  names(ci)<-c("mean","lower","upper")
  return(ci)
}
#======================================================================
# function to get s differences
#======================================================================
calcSD <- function(ci,ci.b, make_plot=TRUE) {
  # 1
  comps = ci$contrast
  labels <- do.call(rbind, strsplit(comps, " - "))
  #lower.CL = ci$lower.CL
  #upper.CL = ci$upper.CL
  lower.CL = ci.b$lower
  upper.CL = ci.b$upper
  
  # 3
  sdH1  = lower.CL > 0 | upper.CL < 0
  # 4
  H1 <- sdH1
  V <- unique(c(labels))
  E <- c(t(labels[!H1,]))
  isolates <- setdiff(V, unique(c(E)))
  sdGr <- igraph::graph(E, isolates = isolates, directed = F)
  if (make_plot) plot(sdGr)
  mc <- igraph::max_cliques(sdGr)
  out <- character(length(V))
  for(i in seq_along(mc)) {
    out <- paste0(out, ifelse(V %in% names(mc[[i]]), letters[i], ""))
  }
  return(out)
}
#======================================================================
# function to significance test 
#======================================================================
compare_means <- function(object, specs,dt1,
                          upper_margin, lower_margin = -upper_margin,
                          method = c("sd", "eq"),
                          level = 0.99,
                          make_plot = TRUE) {
  
  em <- emmeans::emmeans(object = fm, specs = "modc",  method = "mvt")
  pc <- pairs(em)
  # list data by models
  idx<-sort(unique(dt1$modc))
  x<-list()
  for (i in 1:length(idx)) {
    x[[i]]<-dt1%>%filter(modc%in%c(idx[i]))%>%select(y)
    names(x)[i]<-idx[i]
  }
  # list confidence intervals by models with bootstrap non-parametric method
  ci.b<-list()  
  
  for (i in 1:length(x)) {
    xi<-x[[i]]$y
    ci.b[[i]]<-boot_fun(x[[i]]$y)
    names(ci.b)[i]<-names(x)[i]
  }  
  
  ci.b<-bind_rows(ci.b)
  ci.b$contrast<-idx
  # intervals 99% confidence
  ci <- confint(pc, level = 0.99)
  em <- as.data.frame(em)
  if ("sd" %in% method) {
    em$sd <- calcSD(ci,ci.b)
  }
  em$lower.ci.boot<-ci.b$lower
  em$upper.ci.boot<-ci.b$upper
  em<-em[,c(1,2,3,4,8,9,7)]
  
  return(em)
}
```

## 1. Significance testing with meat quality traits
```{r}
#traits
cont_struc2<-rbind(
  c("last_lum.1"),c("dress_ptg.1"), c("car_length.1"),c("belly.1"),
  c("juiciness.1"),c("WBS.1"),c("ph_24h.1"),c("driploss.1"),
  c("protein.1"),c("cook_yield.1"),c("bf10_22wk.1"),c("lma_22wk.1"), 
  c("ham.1"),c("loin.1"),  c("fat.1"),c("moisture.1"), 
  c( "tenderness.1"),c("boston.1"),c( "spareribs.1"),c("picnic.1")
)
# tests as in Shcrauf (2021) paper 
for (i in 1:nrow(cont_struc2)) {
  t1<-foldr%>%filter(lc.trait==cont_struc2[i])
  d1<-t1%>%select(replicate,fold,dA22_Gibs)%>%mutate(modc="A22_Gibs",y=dA22_Gibs)%>%
    select(replicate,fold,modc,y)
  d2<-t1%>%select(replicate,fold,dA22_Gibd)%>%mutate(modc="A22_Gibd",y=dA22_Gibd)%>%
    select(replicate,fold,modc,y)
  d3<-t1%>%select(replicate,fold,dGibd_Gibs)%>%mutate(modc="Gibd_Gibs",y=dGibd_Gibs)%>%
    select(replicate,fold,modc,y)
  dt<-rbind(d1,d2,d3)
  dt<-dt%>%mutate(rep=paste(replicate,fold,sep = "_"))
  fm <- lm(y ~ modc , data = dt)
  
  print("==========================================================================")
  print("============================= Next trait =================================")
  print("==========================================================================")
  print(cont_struc2[i])
  print(compare_means(fm, "modc", 10.0,dt1 = dt,
                      method = c("sd"),
                      level = 0.99))
}

```





