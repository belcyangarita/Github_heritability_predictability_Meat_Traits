---
title: "Predictive ability in meat quality traits"
author: "Belcy Karine Angarita Barajas"
date: "21/09/2020"
output: html_document
---


### 1. Predictive ability meat quality and carcass traits 

The statistical model fitted for each meat quality and carcass trait was: 

$\mathbf{Y= X \beta + Zu +e}$

Using 3 different relationship matrices, the genomic relationship matrix $\mathbf{G_{ibs}}$ computed as $VanRaden\ (2008)$,the genomic relationship matrix $\mathbf{G_{ibd}}$ computed as $Han\ and\ Abney\ (2011)$ and the additive relationship matrix $\mathbf{A_{22}}$.

To calculate the $predictive\ ability$, we used the Pearson correlation coefficient among predicted and observed fenotype $\hat{r}(y,\hat{y})$ obtained by 5-fold crossvalidation.  

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dplyr)
library(kableExtra)

rm(list=ls())
setwd("~/Documents/Github_heritability_predictability_Meat_Traits//")
# Result by replicate
ibs<-read.table("resu_corval_Gibs")
Amat<-read.table("resu_corval_A")
ibd2<-read.table("resu_corval_Gibd")


# 1. Correlation by replicate for each lesion count trait 
colnames(ibs)<-c("replicate","cor_y_yhat_Gvr","lc.trait")
colnames(Amat)<-c("replicate","cor_y_yhat_A22","lc.trait")
colnames(ibd2)<-c("replicate","cor_y_yhat_Ghya","lc.trait")

ibs<-select(ibs, replicate, lc.trait, cor_y_yhat_Gvr)%>%arrange(lc.trait) 
Amat<-select(Amat, replicate, lc.trait, cor_y_yhat_A22)%>%arrange(lc.trait)
ibd2<-select(ibd2, replicate, lc.trait, cor_y_yhat_Ghya)%>%arrange(lc.trait) 

# 2. datafile correlation estimated in each iteration for each matrix,
# and winner matrix by replicate
validres<-Amat%>%left_join(ibs)%>%left_join(ibd2)
validres<-validres%>%filter(!is.na(cor_y_yhat_Gvr),!is.na(cor_y_yhat_Ghya))

rp<-validres%>%arrange(replicate)%>%count(replicate)%>%filter(n==20)
validres<-rp%>%left_join(validres)
validres<-validres%>%select(replicate,lc.trait:cor_y_yhat_Ghya)


# 3. list by trait results of correlation y,yhat replicate
trt<-as.vector(names(table(validres$lc.trait)))
result.cor.traits<-list()

```

### 1.1. Multiple comparison procedure

$Tukey$ multiple comparison was used to test the significance of differences in predictive ability estimates by each trait. The lineal model fitted was:

$\hat{r}_{ij}={\tau}_i\ +\ {\epsilon}_{ij}$

where: $\hat{r}(y,\hat{y})$ is the es la j-ésima correlación estimada $(j1,...,213)$, ${\tau}_i$ is the effect of relationship matrix $(i=1,2,3)$ for $\mathbf{A_{22}},\mathbf{G_{ibs}},\mathbf{G_{ibd}}$, 
 
```{r,include=FALSE,warning=FALSE,message=FALSE}

ibs<-validres%>%
  mutate(mat=as.factor("Gvr"), replicate=as.factor(replicate),cor_y_yhat=cor_y_yhat_Gvr)%>%
  select(replicate, lc.trait, cor_y_yhat, mat)
ibd2<-validres%>%
  mutate(mat=as.factor("Gibd"), replicate=as.factor(replicate),cor_y_yhat=cor_y_yhat_Ghya)%>%
  select(replicate, lc.trait,cor_y_yhat, mat)
Amat<-validres%>%
  mutate(mat=as.factor("A"), replicate=as.factor(replicate),cor_y_yhat=cor_y_yhat_A22)%>%
  select(replicate, lc.trait, cor_y_yhat, mat)
dat<-rbind(Amat,ibs,ibd2)%>%arrange(lc.trait)
trt<-as.vector(names(table(validres$lc.trait)))
result.cor.traits<-list()
for (i in 1:length(trt)) {
  result.cor.traits[[i]]<-filter(dat, lc.trait==trt[i])%>%select(lc.trait,replicate,cor_y_yhat,mat)
  names(result.cor.traits)[i]<-trt[i]
}

# Get means with their standard errors and confidence intervals
library(emmeans)
library(lsmeans)
# 
modtraits<-lapply(result.cor.traits, function(x)lm(cor_y_yhat ~ -1+mat+replicate,data = x))
m.se<-lapply(modtraits, function(x)lsmeans(x,~mat))
library(multcomp)
# Tukey Multiple comparison test
r.anova<-lapply(result.cor.traits, function(x)lm(cor_y_yhat ~ -1+mat+replicate,data = x))
t.shf<-lapply(r.anova, function(x)summary(glht(x,linfct=mcp(mat="Tukey"))))
lt<-lapply(t.shf, function(x)cld(x,decreasing=T))

m.se<-m.se%>%map_df(as_tibble)%>%arrange(mat)%>%mutate(lc.trait=rep(trt,3))
m.se<-cbind(m.se[1:20,7],m.se[1:20,-c(4,7)],m.se[21:40,-c(4,7)],m.se[41:60,-c(4,7)])
m<-m.se[,c(1,3:6,8:11,13:16)]
m<-m%>%keep(is.numeric)%>%round(.,4)
m<-cbind(m.se[,1],m)
colnames(m)<-c("Trait",rep(c("Mean","SE","Low.CI","Up.CI"),3))

mat<-rep(c("A","Gvr","Gibd"),20)

lt<-lapply(lt, function(x)(x$mcletters$Letters))%>%map_df(as_tibble)%>%mutate(mat=mat)
d<-matrix(lt$value,ncol = 3,byrow = T)
colnames(d)<-c("A","Gvr","Gibd")
m<-cbind(m,d)
```

```{r}
names(m)[14:16] <- paste0(names(m)[14:16], 
                                footnote_marker_symbol(1))
kable(m,escape = F)%>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),full_width = F, 
               position = "center") %>%column_spec(1,bold = T)%>%
    add_header_above(c(" ","A"= 4,"Gibs"= 4, "Gibd"= 4,"significance difference"=3))%>%
  add_header_above(c(" ", "correlation y vs yhat" = 15), italic = T,bold = T)%>%
  column_spec(c(2,6,10,14:16),italic = T,color = "black")%>%
  row_spec(c(3,16), background = "#CCEAAA")%>%
  row_spec(c(1,2,4:8,11,12,15,17:20), background = "#D0E0F0")%>%footnote(symbol = "Different letters in the same row indicate a statistically significant difference between relationship matrices (p<0.05)")

```

 




